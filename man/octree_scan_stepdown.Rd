% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/octree_scan_stepdown.R
\name{octree_scan_stepdown}
\alias{octree_scan_stepdown}
\title{Octree scan with hierarchical step-down inference (U0-only)}
\usage{
octree_scan_stepdown(
  z_vol,
  prior_vol = NULL,
  mask = NULL,
  alpha = 0.05,
  n_perm = 1000,
  null = c("signflip_voxel", "mc_fwhm", "mc_acf"),
  null_fun = NULL,
  fwhm_vox = NULL,
  fwhm_mm = NULL,
  acf_params = NULL,
  gamma = 0.5,
  min_voxels = 8,
  min_alpha = 1e-06,
  report = c("coarsest", "finest", "greedy"),
  seed = NULL,
  two_sided = FALSE,
  prior_eta = 0.9
)
}
\arguments{
\item{z_vol}{A 3D volume-like object containing Z-equivalent values.}

\item{prior_vol}{Optional prior weight volume aligned to \code{z_vol}.
If NULL, uniform weights are used.}

\item{mask}{Optional logical mask (same shape as \code{z_vol}). If NULL,
uses all finite voxels in \code{z_vol}.}

\item{alpha}{FWER target (default 0.05).}

\item{n_perm}{Number of sign-flip permutations per tested family (default 1000).}

\item{null}{Null calibration method.
\describe{
\item{\code{"mc_fwhm"}}{Correlated Monte Carlo null via Gaussian smoothing
of white noise with smoothness set by \code{fwhm_vox} (or \code{fwhm_mm}
for \code{NeuroVol}s). If both are NULL, an effective \code{fwhm_vox} is
estimated from the statistic map using \code{\link{estimate_fwhm_vox}}.}
\item{\code{"mc_acf"}}{Correlated Monte Carlo null using a simple mixed-ACF
model (Gaussian + long-tailed exponential) with user-supplied parameters
\code{acf_params}.}
\item{\code{"signflip_voxel"}}{Independent voxelwise sign-flips of the
group map (fast but generally invalid for regional/multiscale statistics;
mainly useful for debugging).}
}}

\item{null_fun}{Optional function \code{function(b)} returning a length
\code{n_mask} Z-vector for permutation \code{b}. Use this to supply
subject-level randomization that preserves spatial covariance.}

\item{fwhm_vox}{For \code{null="mc_fwhm"}, Gaussian FWHM in voxel units
(length 1 or 3).}

\item{fwhm_mm}{For \code{null="mc_fwhm"}, Gaussian FWHM in mm (length 1 or 3).
Requires \code{z_vol} to be a \code{neuroim2::NeuroVol} so voxel spacing is
available.}

\item{acf_params}{For \code{null="mc_acf"}, a list with components:
\describe{
\item{a}{Mixing weight in (0, 1) for the Gaussian component.}
\item{fwhm_vox}{Gaussian ACF FWHM in voxel units (length 1 or 3).}
\item{lambda_vox}{Exponential kernel scale in voxel units (length 1 or 3).}
}}

\item{gamma}{Fraction of the local alpha budget used to test the current
sibling family (default 0.5). Remaining budget is split among rejected
children by prior mass.}

\item{min_voxels}{Minimum child size to consider for descent (default 8).}

\item{min_alpha}{Minimum alpha budget to continue descent (default 1e-6).}

\item{report}{How to select a non-redundant set of regions from the discovered
significant nodes: \code{"coarsest"}, \code{"finest"}, or \code{"greedy"}.}

\item{seed}{Optional RNG seed.}

\item{two_sided}{Logical; if TRUE, uses \code{abs(z_vol)} for the observed map
and permutations (two-sided via absolute Z).}

\item{prior_eta}{Mixing weight in [0, 1] to shrink the prior toward uniform
mass (default 0.9).}
}
\value{
A list with components:
\describe{
\item{hits}{Data frame of all discovered significant nodes (may include nested nodes).}
\item{selected}{Data frame of selected nodes per \code{report}.}
\item{sig_mask}{Logical mask volume for \code{selected} nodes.}
\item{sig_indices}{1-based linear indices into \code{z_vol} for \code{sig_mask}.}
\item{params}{Run parameters.}
}
}
\description{
Performs a multiscale dyadic-cube search using the variance-stabilized
prior-weighted mean statistic \eqn{U_0(R)} and applies a Westfall-Young
step-down procedure \emph{within each sibling family} during octree descent
(alpha-spending across the tree).
}
\details{
Compared to \code{\link{octree_scan_fwer}}, this avoids a single global maxT
threshold over all dyadic cubes. Instead, it leverages the nesting of the
tree and tests only small sibling families (<= 8) at each split.

Note: this is not the same as a global Westfall-Young step-down over the full
set of dyadic cubes (which would require the joint null distribution over
all hypotheses). Use \code{\link{octree_scan_fwer}} for a single-step maxT
procedure over the full dyadic-cube family.
}
